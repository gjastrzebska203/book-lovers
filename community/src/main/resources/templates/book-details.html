<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head th:replace="~{fragments/layout :: head('Szczegóły książki')}"></head>
  <body>
    <nav th:replace="~{fragments/layout :: navigation}"></nav>

    <style>
      /* --- GLOBALNE TŁO I UKŁAD (Sticky Footer) --- */
      body {
        background-color: #f4f1ea !important;
        color: #382110;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .content-wrapper {
        flex: 1;
      }

      /* --- TYPOGRAFIA --- */
      h1,
      h2,
      h3,
      h4,
      .gr-font {
        font-family: "Georgia", serif;
        font-weight: bold;
        color: #382110;
      }

      /* --- OKŁADKA --- */
      .book-cover-container {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        overflow: hidden;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #d6d0c4;
      }
      .book-cover-placeholder {
        background-color: #eaddcf;
        color: #8c8177;
        width: 100%;
        height: 300px; /* Stała wysokość */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* --- PRZYCISKI --- */
      .btn-brown {
        background-color: #382110;
        color: #fff;
        border: 1px solid #382110;
        font-weight: 600;
        transition: all 0.2s;
        border-radius: 30px; /* Zaokrąglone przyciski jak na GR */
      }
      .btn-brown:hover {
        background-color: #5a3b1c;
        color: #fff;
      }
      .btn-outline-brown {
        background-color: transparent;
        color: #382110;
        border: 1px solid #382110;
        font-weight: 600;
        border-radius: 30px;
      }
      .btn-outline-brown:hover {
        background-color: #382110;
        color: #fff;
      }

      /* --- RECENZJE --- */
      .review-card {
        border-top: 1px solid #d6d0c4;
        padding-top: 1.5rem;
        margin-top: 1.5rem;
      }
      .user-avatar-small {
        width: 40px;
        height: 40px;
        background-color: #eaddcf;
        color: #382110;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
      }
    </style>

    <div class="container content-wrapper mt-5 mb-5">
      <div
        th:if="${param.added}"
        class="alert alert-success alert-dismissible fade show shadow-sm"
        role="alert"
      >
        <i class="fas fa-check-circle me-2"></i>Książka została dodana do Twojej
        półki!
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>

      <div class="row g-5">
        <div class="col-md-4 col-lg-3">
          <div class="book-cover-container mb-3 mx-auto">
            <img
              th:if="${book.coverImage != null && !book.coverImage.isEmpty()}"
              th:src="${book.coverImage}"
              class="img-fluid"
              alt="Okładka"
            />

            <div
              th:unless="${book.coverImage != null && !book.coverImage.isEmpty()}"
              class="book-cover-placeholder"
            >
              <i class="fas fa-book fa-5x"></i>
            </div>
          </div>

          <div
            sec:authorize="isAuthenticated()"
            class="d-grid gap-2 text-center"
          >
            <form
              th:action="@{'/books/' + ${book.id} + '/add-to-shelf'}"
              method="post"
            >
              <label class="small text-muted mb-1">Dodaj do półki:</label>
              <div class="input-group">
                <select
                  name="shelfId"
                  class="form-select form-select-sm border-brown"
                  style="border-color: #382110"
                >
                  <option
                    th:each="shelf : ${userShelves}"
                    th:value="${shelf.id}"
                    th:text="${shelf.name}"
                  >
                    Chcę przeczytać
                  </option>
                </select>
                <button class="btn btn-brown btn-sm" type="submit">
                  <i class="fas fa-check"></i>
                </button>
              </div>
            </form>

            <div class="mt-3">
              <a
                href="#reviewForm"
                class="text-decoration-none text-muted small"
              >
                <i class="fas fa-star me-1"></i>Oceń tę książkę
              </a>
            </div>
          </div>

          <div
            sec:authorize="!isAuthenticated()"
            class="d-grid gap-2 text-center"
          >
            <a href="/login" class="btn btn-brown btn-sm">
              Zaloguj się, aby dodać
            </a>
            <small class="text-muted fst-italic" style="font-size: 0.8rem">
              Dołącz do społeczności, aby śledzić lektury.
            </small>
          </div>
        </div>

        <div class="col-md-8 col-lg-9">
          <h1 th:text="${book.title}" class="mb-1 display-5">Tytuł Książki</h1>
          <h3
            class="text-muted mb-3 fs-4"
            style="font-family: &quot;Georgia&quot;, serif"
          >
            <span class="text-dark" th:text="${book.authorName}">Autor</span>
          </h3>

          <div
            class="d-flex align-items-center mb-4 border-bottom pb-4"
            style="border-color: #d6d0c4 !important"
          >
            <div class="d-flex text-warning fs-5 me-2">
              <i
                class="fas fa-star"
                th:each="i : ${#numbers.sequence(1, 5)}"
                th:classappend="${book.averageRating >= i} ? '' : 'text-muted opacity-25'"
              ></i>
            </div>
            <span
              class="fs-4 fw-bold me-2"
              th:text="${#numbers.formatDecimal(book.averageRating, 1, 2)}"
              >0.0</span
            >
            <span class="text-muted small">
              | ISBN: <span th:text="${book.isbn}"></span
            ></span>
          </div>

          <div class="mb-5">
            <p
              class="fs-6 lh-lg"
              th:text="${book.description != null ? book.description : 'Brak opisu dla tej książki.'}"
            >
              Opis książki...
            </p>
          </div>
          <div
            class="card mb-4 border-0 shadow-sm"
            style="background-color: #faf9f6"
          >
            <div class="card-body">
              <h5 class="gr-font mb-4 border-bottom pb-2">
                Statystyki Społeczności
              </h5>

              <div class="row align-items-center text-center text-md-start">
                <div class="col-md-4 mb-4 mb-md-0 border-end-md">
                  <div
                    class="display-4 fw-bold text-dark"
                    th:text="${stats.averageRating}"
                  >
                    7.5
                  </div>

                  <div
                    class="text-warning mb-2"
                    style="font-size: 0.8rem; letter-spacing: -1px"
                  >
                    <span th:each="i : ${#numbers.sequence(1, 10)}">
                      <i
                        th:class="${i <= stats.averageRating} ? 'fas fa-star' : 'far fa-star'"
                      ></i>
                    </span>
                  </div>

                  <div class="small text-muted mt-2">
                    <div class="mb-1">
                      <i class="fas fa-pen-nib me-1"></i>
                      <strong th:text="${stats.ratingCount}">120</strong>
                      recenzji
                    </div>
                    <div>
                      <i class="fas fa-user-check me-1"></i>
                      <strong th:text="${stats.readerCount}">350</strong>
                      czytelników
                    </div>
                  </div>
                </div>

                <div class="col-md-8">
                  <div
                    th:each="star : ${#numbers.sequence(10, 1, -1)}"
                    class="d-flex align-items-center mb-1"
                    style="line-height: 1"
                  >
                    <div
                      class="small text-muted me-2 text-end"
                      style="width: 35px; font-size: 0.75rem"
                      th:text="${star}"
                    >
                      10
                    </div>
                    <div class="small text-warning me-2">
                      <i class="fas fa-star" style="font-size: 0.7rem"></i>
                    </div>

                    <div
                      class="progress flex-grow-1"
                      style="
                        height: 6px;
                        background-color: #e9ecef;
                        border-radius: 2px;
                      "
                    >
                      <div
                        class="progress-bar"
                        role="progressbar"
                        th:style="'width: ' + ${stats.getPercentage(star)} + '%; background-color: #ffc107;'"
                        th:aria-valuenow="${stats.getPercentage(star)}"
                        aria-valuemin="0"
                        aria-valuemax="100"
                      ></div>
                    </div>

                    <div
                      class="small text-muted ms-2 text-end"
                      style="width: 40px; font-size: 0.75rem"
                      th:text="${stats.ratingDistribution.get(star)}"
                    >
                      10
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div id="reviewSection">
            <h4
              class="mb-4 border-bottom pb-2"
              style="border-color: #382110 !important"
            >
              Recenzje społeczności
            </h4>

            <div
              sec:authorize="isAuthenticated()"
              id="reviewForm"
              class="bg-white p-4 rounded shadow-sm border mb-5"
              style="border-color: #d6d0c4 !important"
            >
              <h6 class="fw-bold mb-3">Co myślisz o tej książce?</h6>
              <form
                th:action="@{'/books/' + ${book.id} + '/review'}"
                method="post"
              >
                <div class="row mb-3">
                  <div class="col-md-4">
                    <label class="form-label small text-muted"
                      >Twoja ocena</label
                    >
                    <select name="rating" class="form-select">
                      <option value="10">★★★★★★★★★★ (10)</option>
                      <option value="9">★★★★★★★★★☆ (9)</option>
                      <option value="8">★★★★★★★★☆☆ (8)</option>
                      <option value="7">★★★★★★★☆☆☆ (7)</option>
                      <option value="6">★★★★★★☆☆☆☆ (6)</option>
                      <option value="5" selected>★★★★★☆☆☆☆☆ (5)</option>
                      <option value="4">★★★★☆☆☆☆☆☆ (4)</option>
                      <option value="3">★★★☆☆☆☆☆☆☆ (3)</option>
                      <option value="2">★★☆☆☆☆☆☆☆☆ (2)</option>
                      <option value="1">★☆☆☆☆☆☆☆☆☆ (1)</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label small text-muted"
                    >Twoja recenzja</label
                  >
                  <textarea
                    name="content"
                    class="form-control"
                    rows="3"
                    placeholder="Podziel się wrażeniami..."
                    required
                  ></textarea>
                </div>
                <button type="submit" class="btn btn-brown px-4 btn-sm">
                  Opublikuj
                </button>
              </form>
            </div>

            <div
              sec:authorize="!isAuthenticated()"
              class="alert alert-light border text-center mb-5"
              style="border-color: #d6d0c4 !important"
            >
              Chcesz dodać recenzję?
              <a
                href="/login"
                class="text-decoration-underline text-dark fw-bold"
                >Zaloguj się</a
              >.
            </div>

            <div class="reviews-list">
              <div th:each="review : ${reviews}" class="review-card">
                <div class="d-flex">
                  <div class="me-3">
                    <div class="user-avatar-small shadow-sm">
                      <i class="fas fa-user"></i>
                    </div>
                  </div>
                  <div class="flex-grow-1">
                    <div
                      class="d-flex justify-content-between align-items-start"
                    >
                      <div>
                        <span
                          class="fw-bold d-block"
                          style="color: #382110"
                          th:text="${review.user != null ? review.user.username : 'Użytkownik usunięty'}"
                        >
                          User
                        </span>
                        <span
                          class="text-muted small"
                          th:text="${#temporals.format(review.createdAt, 'd MMMM yyyy')}"
                          >Data</span
                        >
                      </div>
                      <div class="text-warning small">
                        <span
                          class="fw-bold text-dark me-1"
                          th:text="${review.rating}"
                          >5</span
                        >/10
                        <i class="fas fa-star"></i>
                      </div>
                    </div>

                    <p
                      class="mt-2 mb-0 text-dark"
                      style="white-space: pre-line"
                      th:text="${review.content}"
                    >
                      Treść recenzji...
                    </p>
                  </div>
                </div>
              </div>

              <div th:if="${reviews.empty}" class="text-muted fst-italic mt-3">
                Nikt jeszcze nie zrecenzował tej książki.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
  </body>
</html>
