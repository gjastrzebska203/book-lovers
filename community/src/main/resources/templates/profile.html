<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{fragments/layout :: head('Twój Profil')}"></head>
  <body>
    <nav th:replace="~{fragments/layout :: navigation}"></nav>

    <style>
      /* --- GLOBAL LAYOUT --- */
      body {
        background-color: #f4f1ea !important;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        color: #382110;
      }
      .content-wrapper {
        flex: 1;
      }

      /* --- TYPOGRAFIA & KOLORY --- */
      h1,
      h2,
      h3,
      h4,
      .gr-font {
        font-family: "Georgia", serif;
        font-weight: bold;
        color: #382110;
      }
      a {
        color: #382110;
        text-decoration: none;
      }
      a:hover {
        color: #5a3b1c;
        text-decoration: underline;
      }

      /* --- WIDGET WYZWANIA --- */
      .challenge-card {
        background-color: #ffffff;
        border: 1px solid #d6d0c4;
        border-top: 5px solid #382110;
        border-radius: 4px;
      }
      .challenge-number {
        font-family: "Georgia", serif;
        font-weight: bold;
        color: #382110;
      }

      /* --- ZAKŁADKI --- */
      .nav-tabs {
        border-bottom: 1px solid #d6d0c4;
      }
      .nav-tabs .nav-link {
        color: #666;
        border: none;
        background: transparent;
        font-weight: 600;
        padding-bottom: 10px;
        margin-right: 20px;
      }
      .nav-tabs .nav-link:hover {
        color: #382110;
      }
      .nav-tabs .nav-link.active {
        color: #382110;
        border-bottom: 3px solid #382110;
      }

      /* --- STYLE DLA AVATARA --- */
      .avatar-placeholder {
        width: 140px;
        height: 140px;
        background-color: #eaddcf; /* Beżowy kolor tła */
        color: #382110; /* Brązowa ikona */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        border: 2px solid #fff;
      }

      /* --- RESZTA STYLI --- */
      .book-placeholder {
        background-color: #eaddcf;
        color: #8c8177;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 180px; /* Dopasowane do kart */
        border-radius: 2px;
      }
      .shelf-header {
        border-bottom: 1px solid #d6d0c4;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .btn-brown {
        background-color: #382110;
        color: #fff;
        border: 1px solid #382110;
      }
      .btn-brown:hover {
        background-color: #5a3b1c;
        color: #fff;
      }
      /* Dodany styl dla przycisku Przenieś */
      .btn-outline-brown {
        color: #382110;
        border-color: #382110;
        background-color: transparent;
      }
      .btn-outline-brown:hover {
        background-color: #382110;
        color: #fff;
      }
      .form-control:focus {
        border-color: #382110;
        box-shadow: 0 0 0 0.25rem rgba(56, 33, 16, 0.25);
      }
    </style>

    <div class="container content-wrapper mt-5">
      <div class="row mb-5">
        <div
          class="col-md-2 text-center text-md-start mb-3 mb-md-0 d-flex justify-content-center justify-content-md-start"
        >
          <img
            th:if="${user.avatar != null && !user.avatar.isEmpty()}"
            th:src="${user.avatar}"
            class="rounded-circle border border-2 shadow-sm"
            style="
              width: 140px;
              height: 140px;
              object-fit: cover;
              border-color: #fff !important;
            "
            alt="Avatar"
          />

          <div
            th:unless="${user.avatar != null && !user.avatar.isEmpty()}"
            class="avatar-placeholder shadow-sm"
          >
            <i class="fas fa-user fa-4x"></i>
          </div>
        </div>

        <div class="col-md-6 pt-2">
          <h2 th:text="${user.username}" class="mb-1">Nazwa użytkownika</h2>
          <p class="text-muted small mb-3" th:text="${user.email}">
            email@example.com
          </p>

          <div
            class="p-3 bg-white border rounded"
            style="border-color: #d6d0c4 !important"
          >
            <small
              class="text-uppercase text-muted fw-bold"
              style="font-size: 0.7rem"
              >O mnie</small
            >
            <p
              class="mb-0 mt-1"
              th:text="${user.bio != null && !user.bio.isEmpty() ? user.bio : 'Ten użytkownik nie dodał jeszcze opisu.'}"
              style="font-style: italic"
            >
              Bio użytkownika...
            </p>
          </div>
        </div>

        <div class="col-md-4 mt-4 mt-md-0">
          <div class="challenge-card p-3 shadow-sm text-center">
            <h5 class="text-uppercase fw-bold text-muted small mb-3">
              Wyzwanie 2024
            </h5>
            <div class="d-flex justify-content-center align-items-center gap-3">
              <i class="fas fa-trophy fa-2x" style="color: #d4a017"></i>
              <div>
                <h1
                  class="display-4 mb-0 challenge-number"
                  th:text="${booksReadYear}"
                >
                  0
                </h1>
                <small class="text-muted">przeczytanych książek</small>
              </div>
            </div>
            <div
              class="progress mt-3"
              style="height: 6px; background-color: #e9ecef"
            >
              <div
                class="progress-bar"
                role="progressbar"
                style="width: 0%; background-color: #382110"
                th:style="'width: ' + (${booksReadYear} > 0 ? '25%' : '0%')"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
        <li class="nav-item">
          <button
            class="nav-link active"
            id="shelves-tab"
            data-bs-toggle="tab"
            data-bs-target="#shelves"
            type="button"
          >
            Moja Biblioteczka
          </button>
        </li>
        <li class="nav-item">
          <button
            class="nav-link"
            id="settings-tab"
            data-bs-toggle="tab"
            data-bs-target="#settings"
            type="button"
          >
            Edycja Profilu
          </button>
        </li>
      </ul>

      <div class="tab-content" id="profileTabsContent">
        <div class="tab-pane fade show active" id="shelves" role="tabpanel">
          <div class="card mb-5 border-0 bg-light">
            <div
              class="card-body p-4 d-flex align-items-center justify-content-between flex-wrap gap-3"
            >
              <div>
                <h5 class="gr-font mb-1">
                  <i class="fas fa-plus-circle me-2"></i>Nowa półka
                </h5>
                <p class="text-muted small mb-0">
                  Stwórz nową kategorię dla swoich książek.
                </p>
              </div>

              <form
                th:action="@{/profile/shelves/create}"
                method="post"
                class="d-flex gap-2"
                style="min-width: 300px"
              >
                <input
                  type="text"
                  name="shelfName"
                  class="form-control"
                  placeholder="Np. Fantastyka, Ulubione..."
                  required
                />
                <button type="submit" class="btn btn-brown text-nowrap">
                  Dodaj
                </button>
              </form>
            </div>
          </div>

          <div
            th:if="${param.shelfCreated}"
            class="alert alert-success alert-dismissible fade show"
            role="alert"
          >
            Półka została utworzona pomyślnie!
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>
          <div
            th:if="${param.error}"
            class="alert alert-warning alert-dismissible fade show"
            role="alert"
          >
            <span th:text="${param.error}">Błąd</span>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
              aria-label="Close"
            ></button>
          </div>

          <div th:each="shelf : ${shelves}" class="mb-5">
            <div
              class="shelf-header d-flex justify-content-between align-items-center"
            >
              <h4 class="mb-0">
                <span th:text="${shelf.name}">Przeczytane</span>
                <span
                  class="text-muted fw-normal ms-2 fs-6"
                  th:text="'(' + ${shelf.books.size()} + ')'"
                >
                  (0)</span
                >
              </h4>
            </div>

            <div class="row row-cols-2 row-cols-md-4 row-cols-lg-6 g-3">
              <div class="col" th:each="book : ${shelf.books}">
                <div
                  class="card h-100 border-0 shadow-sm"
                  style="background-color: #fff"
                >
                  <a
                    th:href="@{'/books/' + ${book.id}}"
                    class="text-decoration-none text-dark"
                  >
                    <div
                      th:if="${book.coverImage != null}"
                      class="position-relative"
                    >
                      <img
                        th:src="${book.coverImage}"
                        class="card-img-top"
                        style="height: 180px; object-fit: cover"
                        alt="Okładka"
                      />
                    </div>
                    <div
                      th:unless="${book.coverImage != null}"
                      class="book-placeholder card-img-top"
                      style="height: 180px"
                    >
                      <i class="fas fa-book fa-2x"></i>
                    </div>
                    <div class="card-body p-2">
                      <h6
                        class="card-title small fw-bold mb-0 text-truncate"
                        th:text="${book.title}"
                        style="color: #382110"
                      >
                        Tytuł
                      </h6>
                      <p
                        class="card-text small text-muted text-truncate"
                        th:text="${book.author.lastName}"
                      >
                        Autor
                      </p>
                    </div>
                  </a>

                  <div class="card-footer bg-white border-top-0 p-2 pt-0">
                    <div
                      class="d-flex justify-content-between align-items-center gap-1"
                    >
                      <div class="dropdown flex-grow-1">
                        <button
                          class="btn btn-sm btn-outline-brown w-100 dropdown-toggle py-0"
                          style="font-size: 0.75rem"
                          type="button"
                          data-bs-toggle="dropdown"
                        >
                          Przenieś
                        </button>
                        <ul
                          class="dropdown-menu shadow border-0"
                          style="min-width: 200px; z-index: 1050"
                        >
                          <li>
                            <h6 class="dropdown-header small">
                              Wybierz półkę docelową:
                            </h6>
                          </li>
                          <li
                            th:each="targetShelf : ${shelves}"
                            th:if="${targetShelf.id != shelf.id}"
                          >
                            <form
                              th:action="@{'/profile/shelves/' + ${shelf.id} + '/move'}"
                              method="post"
                            >
                              <input
                                type="hidden"
                                name="bookId"
                                th:value="${book.id}"
                              />
                              <input
                                type="hidden"
                                name="targetShelfId"
                                th:value="${targetShelf.id}"
                              />
                              <button type="submit" class="dropdown-item small">
                                <i class="fas fa-folder me-2 text-muted"></i>
                                <span th:text="${targetShelf.name}">Nazwa</span>
                              </button>
                            </form>
                          </li>
                          <li
                            th:if="${shelves.size() <= 1}"
                            class="dropdown-item small text-muted fst-italic"
                          >
                            Brak innych półek
                          </li>
                        </ul>
                      </div>

                      <form
                        th:action="@{'/profile/shelves/' + ${shelf.id} + '/remove'}"
                        method="post"
                        onsubmit="return confirm('Usunąć tę książkę z półki?');"
                      >
                        <input
                          type="hidden"
                          name="bookId"
                          th:value="${book.id}"
                        />
                        <button
                          type="submit"
                          class="btn btn-sm text-danger px-2 py-0"
                          title="Usuń z półki"
                        >
                          <i class="fas fa-times"></i>
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12" th:if="${shelf.books.empty}">
                <div
                  class="p-3 text-muted fst-italic bg-light border rounded text-center"
                >
                  Brak książek na tej półce.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="settings" role="tabpanel">
          <div class="row">
            <div class="col-md-8 col-lg-6">
              <div
                class="card border-0 shadow-sm"
                style="border: 1px solid #d6d0c4 !important"
              >
                <div class="card-body p-4">
                  <h4 class="card-title mb-4 border-bottom pb-2">
                    Aktualizuj profil
                  </h4>
                  <div
                    th:if="${param.updated}"
                    class="alert alert-success small"
                  >
                    <i class="fas fa-check-circle me-1"></i> Profil został
                    zaktualizowany!
                  </div>
                  <form
                    th:action="@{/profile/update}"
                    method="post"
                    enctype="multipart/form-data"
                  >
                    <div class="mb-3">
                      <label class="form-label fw-bold small"
                        >O mnie (Bio)</label
                      >
                      <textarea
                        name="bio"
                        class="form-control"
                        rows="4"
                        th:text="${user.bio}"
                        placeholder="Napisz coś o swoich literackich gustach..."
                      ></textarea>
                    </div>
                    <div class="mb-4">
                      <label class="form-label fw-bold small"
                        >Zmień Avatar</label
                      >
                      <input
                        type="file"
                        name="avatar"
                        class="form-control"
                        accept="image/*"
                      />
                      <div class="form-text small">
                        Zalecane formaty: JPG, PNG.
                      </div>
                    </div>
                    <button type="submit" class="btn btn-brown px-4">
                      Zapisz zmiany
                    </button>
                  </form>
                </div>
              </div>

              <hr class="my-5" style="border-color: #d6d0c4" />

              <div
                class="card border-0 shadow-sm mb-4"
                style="border: 1px solid #d6d0c4 !important"
              >
                <div class="card-body p-4">
                  <h4 class="card-title mb-3 gr-font">
                    <i class="fas fa-database me-2 text-muted"></i>Backup i Dane
                  </h4>
                  <p class="card-text text-muted mb-4">
                    Możesz pobrać kopię wszystkich swoich półek, książek i
                    recenzji w formacie JSON. Plik ten pozwoli Ci zachować
                    historię czytania na dysku komputera.
                  </p>

                  <a href="/profile/export" class="btn btn-brown px-4">
                    <i class="fas fa-download me-2"></i>Pobierz Backup (JSON)
                  </a>
                </div>
              </div>

              <div
                class="card border-0 shadow-sm"
                style="
                  border: 1px solid #ebb1b7 !important;
                  background-color: #fdf3f4;
                "
              >
                <div class="card-body p-4">
                  <h4 class="card-title mb-3 gr-font" style="color: #c82333">
                    <i class="fas fa-exclamation-triangle me-2"></i>Strefa
                    niebezpieczna
                  </h4>

                  <div class="mt-3">
                    <h6 class="fw-bold mb-2" style="color: #382110">
                      Usuwanie konta
                    </h6>
                    <p class="card-text text-muted mb-3 small">
                      Ta operacja jest <strong>nieodwracalna</strong>. Wszystkie
                      Twoje recenzje, oceny i półki zostaną trwale usunięte.
                    </p>
                    <form
                      th:action="@{/profile/delete}"
                      method="post"
                      onsubmit="
                        return confirm(
                          'Czy na pewno chcesz usunąć konto? Tej operacji nie można cofnąć.',
                        );
                      "
                    >
                      <button
                        type="submit"
                        class="btn btn-sm btn-outline-danger px-3"
                      >
                        <i class="fas fa-trash-alt me-2"></i>Usuń moje konto
                        bezpowrotnie
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer th:replace="~{fragments/layout :: footer}"></footer>
  </body>
</html>
